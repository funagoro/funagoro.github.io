
<!DOCTYPE html>

<html lang="ja">

<head>

<meta charset="utf-8">

<title>oto 6 - MONKEY CIRCUS おさるサーカス</title>
<meta property="og:title" content="oto 6 - MONKEY CIRCUS おさるサーカス">
<meta property="og:url" content="https://funagoro.github.io/experiment/glsl/oto_6/oto_6.html">
<meta property="og:type" content="website">
<meta property="og:image" content="https://funagoro.github.io/experiment/glsl/oto_6/oto_6_t.jpg">
<link rel="apple-touch-icon" href="https://funagoro.github.io/experiment/glsl/oto_6/oto_6_t.jpg">
<meta name="apple-mobile-web-app-title" content="oto 6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="AudioWorklet experiment and GLSL WebGL">

<link rel="shortcut icon" href="favicon.ico" />
<link rel="stylesheet" type="text/css" href="glsl.css" />

<meta name="viewport" content="width=600">
<style> @viewport { width : 600px;} </style>

</head>

<body>



<div class="t"></div>



<canvas id="canvas1" style="width : 512px; height : 512px;"></canvas><br>
<br>
<span class="title">"oto 6" 実験中。</span><br>
&copy;2022 Maeda Mameo<br>
<span id="sp1"></span><br>
<span id="sp2"></span><br>



<div class="b"></div>



<script src="skeleton_touch.js"></script>

<script src="three_130_min.js"></script>

<script>

'use strict';

const W = 512;
let t;

const STATE_DEFAULT = 0, STATE_INIT = 1, STATE_WORKING = 2, STATE_MUTED = 3;
let my_state = STATE_DEFAULT;

const can = document.getElementById( "canvas1");
	can.width = can.height = W;

const ren = new THREE.WebGLRenderer( { canvas : can});

const cam = new THREE.PerspectiveCamera( 40, 1 / 1, 0.1, 100);
	cam.position.set( 0, 0, 5);
	cam.lookAt( 0, 0, 0);

const scene = new THREE.Scene();
	scene.background = new THREE.Color( "white");

const ld = new THREE.TextureLoader();
const tex = ld.load( "data:;base64," +
`R0lGODlhgAAIAIAAAAAAAP///yH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlk
PSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpu
czptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNy4xLWMwMDAgNzkuZWRhMmIzZmFjLCAy
MDIxLzExLzE3LTE3OjIzOjE5ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93
d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJk
ZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5z
OnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0
cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JU
b29sPSJBZG9iZSBQaG90b3Nob3AgMjMuMSAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0i
eG1wLmlpZDo2OTJBMTQwN0IyMTcxMUVDQjVEQjhFQzQzMTc0RkIwRiIgeG1wTU06RG9jdW1lbnRJ
RD0ieG1wLmRpZDo2OTJBMTQwOEIyMTcxMUVDQjVEQjhFQzQzMTc0RkIwRiI+IDx4bXBNTTpEZXJp
dmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjY5MkExNDA1QjIxNzExRUNCNURCOEVD
NDMxNzRGQjBGIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjY5MkExNDA2QjIxNzExRUNCNURC
OEVDNDMxNzRGQjBGIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRh
PiA8P3hwYWNrZXQgZW5kPSJyIj8+Af/+/fz7+vn49/b19PPy8fDv7u3s6+rp6Ofm5eTj4uHg397d
3Nva2djX1tXU09LR0M/OzczLysnIx8bFxMPCwcC/vr28u7q5uLe2tbSzsrGwr66trKuqqainpqWk
o6KhoJ+enZybmpmYl5aVlJOSkZCPjo2Mi4qJiIeGhYSDgoGAf359fHt6eXh3dnV0c3JxcG9ubWxr
amloZ2ZlZGNiYWBfXl1cW1pZWFdWVVRTUlFQT05NTEtKSUhHRkVEQ0JBQD8+PTw7Ojk4NzY1NDMy
MTAvLi0sKyopKCcmJSQjIiEgHx4dHBsaGRgXFhUUExIREA8ODQwLCgkIBwYFBAMCAQAAIfkEAAAA
AAAsAAAAAIAACAAAAoSED6Eb6A+jnLTa+9plC/GjGYw3iqGpiBnIeq6adCg5pdaZrGzIO6f22/ly
xGKuB0MagZIGLoJ7Kpmw1tLqfBGz2Cq1qDS+njprNynTBlFfsNkNn5rJ25otJgWV6Nf+vCT2EXeW
BJHWdHdI2DZEo8UGF4iVmHZ4R8LnaILB2en5+Xn5UAAAOw==`);
tex.magFilter = THREE.NearestFilter;
const o_touch = new THREE.Mesh(
	new THREE.PlaneGeometry( 150, 150),
	//new THREE.MeshBasicMaterial( { color : 0xffeeff, blending : THREE.MultiplyBlending})
	new THREE.MeshBasicMaterial( { color : 0xff7799, transparent : true, opacity : 0.5})
);
o_touch.add( new THREE.Mesh(
	new THREE.PlaneGeometry( 128, 8),
	//new THREE.MeshBasicMaterial( { color : 0xffffff, map : tex, blending : THREE.SubtractiveBlending})
	new THREE.MeshBasicMaterial( { color : 0xffffff, map : tex, blending : THREE.SubtractiveBlending, transparent : true})
));
t = 0.005;
o_touch.scale.set( t, t, t);
o_touch.position.z = 4;
scene.add( o_touch);

scene.add( new THREE.Mesh(
	new THREE.BoxGeometry( 0.5, 0.5, 0.5),
	new THREE.MeshBasicMaterial( { color : 0x0000ff})
));

//◍◍◍◍◍◍◍◍◍◍ ◍◍◍◍◍◍◍◍◍◍ ◍◍◍◍◍◍◍◍◍◍

let ac;
let awnode;
let ab_taiko, gn_taiko;
let absn;

//★ skeleton_touch.js のための設定。
const REFW = W, REFH = W, MAXTOUCH = 5, CAN_PINCH = false;
function touch_event_hook(){

	if( skt.num == 1 && skt.x == skt.bx && skt.y == skt.by){
		//★ シングルタッチでかつ、動いていないタッチに限る。

		//if( ac.state !== "running") await ac.resume();

		if( my_state == STATE_DEFAULT){
document.getElementById( "sp2").innerHTML="futu";
			acc();
		} else if( my_state == STATE_MUTED){
			if( !ac){
document.getElementById( "sp2").innerHTML="nido";
				acc();
			} else{
				//awnode.disconnect( 0);
document.getElementById( "sp2").innerHTML="resu";
				ac.resume();
				my_state = STATE_WORKING;
			}
			o_touch.visible = false;

		}
		function acc(){
			ac = new window.AudioContext();
			ac.createBufferSource().start(); //★ こんなダミーでもいいので、再生する必要がある。
			ac.audioWorklet.addModule( "data:text/javascript," + encodeURI( `

				'use strict';

				class awp extends AudioWorkletProcessor{
					constructor(){
						let that;

						super();

						this.f = 440;
						this.p = 0;
						that = this;
						this.port.onmessage = function( e){
							that.f = parseFloat( e.data);
						}

						//★ こちらのスレッドでは console.log() ができないので、デバグ情報などは、文字列としてメインスレッドに送る。
						this.port.postMessage( "hello!");
					}

					process( inputs, outputs, parameters){
						let i, m, n;

						const output = outputs[ 0];
						//const channel_num = output.length;
						const d = output[ 0];

							n = d.length;
							m = Math.floor( sampleRate / this.f);
							for( i = 0; i < n; i++){
								d[ i] = 0.3 * Math.sin( 2 * Math.PI * this.p / m);
								if( m <= ++this.p) this.p = 0;
							}

						return true;
					}
				}

				registerProcessor( "awp_name", awp);

			`)).then( function(){
				awnode = new AudioWorkletNode( ac, "awp_name");

				awnode.port.onmessage = function( e){ console.log( e.data);}

				document.addEventListener( "visibilitychange", function(){
					let s;

					s = document.visibilityState;
					if( s == "hidden"){
						ac.suspend();
						my_state = STATE_MUTED;
						o_touch.visible = true;
					} else if( s == "visible"){
						//★ タッチで再開するので、ここでは何もしない。
					}
				}, false);

				awnode.connect( ac.destination);
				o_touch.visible = false;

				my_state = STATE_INIT;
				count = 0;
			}).catch( console.error);
		}
	}
}
const skt = new skeleton_touch( can);
skt.set_mag_and_orientation( 1, 0);

//◍◍◍◍◍◍◍◍◍◍ ◍◍◍◍◍◍◍◍◍◍ ◍◍◍◍◍◍◍◍◍◍

let count = 0;

tic();

function tic(){
	let i;
	let t;

	requestAnimationFrame( tic);

	skt.pre();

if(ac&&count%30==0)document.getElementById( "sp1").innerHTML=ac.state;

	if( my_state == STATE_INIT){
		if( count == 0){
			let n, r;
			let t, w;
			let d;

			r = ac.sampleRate;

			//★ 太鼓の音を作る。
			n = 2 * r;
			ab_taiko = ac.createBuffer( 1, n, r); //★ チャンネル数、サンプル数、レート。
			d = ab_taiko.getChannelData( 0);
			for( i = 0; i < n; i++){
				t = 0.7 * i / r;
				t = Math.sqrt( t * 5) / 5;
				w = Math.max( -1, Math.min( 1,
					4 * Math.sin( 6.28318 * 100 * t)
				)) * Math.exp( -10 * Math.max( t - 0.15, 0));
				w += 3 * Math.exp( -15 * t);
				d[ i] = 2 * w;
			}
			gn_taiko = ac.createGain();
			gn_taiko.gain.value = 0.18;
			gn_taiko.connect( ac.destination);

			my_state = STATE_WORKING;
			count = 0;
		}
	} else if( my_state == STATE_WORKING){
		awnode.port.postMessage( 440 * Math.pow( 2, Math.sin( 0.3 * count)));

		if( skt.start){
			absn = ac.createBufferSource();
			absn.buffer = ab_taiko;
			absn.connect( gn_taiko);
			absn.start();
		}
	}

	ren.render( scene, cam);

	skt.post();

	count++;
}
</script>

</body>

</html>
