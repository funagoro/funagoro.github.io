<html>

<head></head>

<body>

<button id="dry">Unaffected</button>
<button id="wet">Effected</button>
<button id="combined">Combined</button>

<script>
//https://blog.gskinner.com/archives/2019/02/reverb-web-audio-api.html
//Matthew Willox

document.getElementById( "dry").addEventListener( "mousedown", function( e){ drySound.play();});
document.getElementById( "wet").addEventListener( "mousedown", function( e){ wetSound.play();});
document.getElementById( "combined").addEventListener( "mousedown", function( e){ combined.play();});

class Sample{
	constructor( context){
		this.context = context;
		this.sampleBuffer = null
		this.loaded = false;
		this.output = this.context.createGain();
	}

	play(){
		if( this.loaded){
			let n = this.context.createBufferSource();
			n.buffer = this.sampleBuffer;
			n.connect( this.output);
			n.start( 0);
		}
	}

	load( path){
		this.loaded = false;
		return fetch( path)
		.then( ( response) => response.arrayBuffer())
		.then( ( myBlob) => {
			return new Promise( ( resolve, reject) => {
				this.context.decodeAudioData( myBlob, resolve, reject);
			})
		})
		.then( ( buf) => {
			this.sampleBuffer = buf;
			this.loaded = true;
			return this;
		})
	}
}

let i, n, r;
let rev, rev_gn, n_gn, hpf, lpf, absn;

const ac = new window.AudioContext;
r = ac.sampleRate;
n = 2 * r; //★ 残響の長さ、2 秒。
const o_ac = new window.OfflineAudioContext( 2, n, r);

n_gn = o_ac.createGain();

let ab = o_ac.createBuffer( 2, n, r);
let d0 = ab.getChannelData( 0);
let d1 = ab.getChannelData( 0);
for( i = 0; i < n; i++){
	const a = 0.001, d = 0.2;
	let v = i / r;
	if( v < a) v = 1 - 1 * Math.exp( -v / a);
	else v = ( 1 - 1 * Math.exp( -1)) * Math.exp( -( v - a) / d);
	d0[ i] = v * ( 2 * Math.random() - 1);
	d1[ i] = v * ( 2 * Math.random() - 1);
}

absn = o_ac.createBufferSource();
absn.buffer = ab;

hpf = o_ac.createBiquadFilter();
hpf.type = "highpass";
hpf.frequency.value = 500;
hpf.Q.value = 0.1;

lpf = o_ac.createBiquadFilter();
lpf.type = "lowpass";
lpf.frequency.value = 2000;
lpf.Q.value = 0.2;

rev_gn = ac.createGain();
rev_gn.connect( ac.destination);
rev_gn.gain.value = 2;

rev = ac.createConvolver();
rev.connect( rev_gn);

o_ac.oncomplete = function( buf){
	rev.buffer = buf.renderedBuffer;
}

absn.connect( hpf);
hpf.connect( lpf);
lpf.connect( o_ac.destination);

o_ac.startRendering();
absn.start( 0);

let u = "https://mwmwmw.github.io/files/Instruments/DrumBeat.mp3";

let drySound = new Sample( ac);
drySound.load( u).then( function( s){
	drySound.output.connect( ac.destination);
});

let wetSound = new Sample( ac);
wetSound.load( u).then( function( s){
	wetSound.output.connect( rev);
});

let combined = new Sample( ac);
combined.load( u).then( function( s){
	combined.output.connect( rev);
	combined.output.connect( ac.destination);
});

</script>

</body>

</html>
